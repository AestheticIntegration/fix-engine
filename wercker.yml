build:
  box:
    id: ocaml/opam2
    tag: debian-9-ocaml-4.06
    entrypoint: /usr/bin/sudo -u root --preserve-env opam config exec --
    cmd: /bin/bash

  steps:
    - script:
        name: dune make
        code: |          
          set -ex
          apt-get update && apt-get install -y libgmp-dev zlib1g-dev
          export OPAMROOT=/home/opam/.opam
          opam update
          opam install dune
          make opam1-setup
          curl -s "https://storage.googleapis.com/imandra-installer/install.sh" > /home/opam/install.sh
          echo -e "/usr/local/bin\n" | sh /home/opam/install.sh -n
          export PATH=/usr/local/bin/:$PATH
          echo -e "#!/bin/sh\n/usr/local/bin/imandra-extract $@" > /usr/local/bin/imandra_extract
          chmod +x /usr/local/bin/imandra_extract
          opam pin add https://github.com/AestheticIntegration/imandra-prelude.git
          make
