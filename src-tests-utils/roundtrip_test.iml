[@@@program]
[@@@require "decoders-yojson"]
[@@@import "../src-protocol-pp/full_messages_decoder.iml"]
[@@@import "../src-protocol-pp/full_messages_json.iml"]
[@@@import "../src-core-time-defaults/time_defaults.iml"]
[@@@import "../src/fix_engine_utils.iml"]
[@@@import "../src-protocol/full_messages.iml"]
open Full_messages_decoder 
open Full_messages_json
open Time_defaults
open Fix_engine_utils
open Full_messages
module D = Decoders_yojson.Basic.Decode;;


let make_fix_msg i =
    let msg = Full_FIX_Admin_Msg ( 
        Full_Msg_Heartbeat { hb_test_req_id = Some "123" }
    ) in
    create_outbound_fix_msg (i - 1, 
        "IMANDRA",     
        "TARGET", 
        make_utctimestamp 2017 1 1 0 1 0 None,
        msg, false
    )
;;

let test () = 
   let orig = make_fix_msg 1  in
   let json = full_valid_msg_to_json orig |> Yojson.Basic.to_string in
   D.decode_string full_valid_msg_decoder json |>
   function 
   | Ok rt -> 
   if rt = orig 
    then () 
    else failwith "incorrect"
  | Error r -> 
    failwith (D.pp_error Format.std_formatter r; failwith "decoding of full message failed")
;;
[@@@logic]